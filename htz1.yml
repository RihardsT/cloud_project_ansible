---
- name: Base setup - User setup, fail2ban, security.
  hosts: all
  become: yes
  become_user: root
  become_method: sudo
  vars:
    app_user: [rihards]
    app_user_groups: [rihards]
    # security_ssh_port: 3013
    security_sudoers_passwordless: [rihards]
    kubernetes_version: '1.27'
    kubernetes_role: control_plane
    kubernetes_ignore_preflight_errors: "all"
    kubernetes_pod_network_cidr: "10.244.0.0/16"
    kubernetes_allow_pods_on_master: True
    kubernetes_config_kubelet_configuration:
      failSwapOn: false
      # containerRuntime: remote
      # containerRuntimeEndpoint: unix:///run/containerd/containerd.sock
    kubernetes_config_init_configuration:
      # localAPIEndpoint:
      #   advertiseAddress: "{{ ansible_default_ipv4.address }}"
      apiserverCertExtraSans: rudenspavasaris.id.lv
  handlers:
    - import_tasks: handlers/containerd.yml
  vars_files:
    - vars/app_user.yml
  pre_tasks:
    - include_tasks: ./tasks/scaleway_dns.yml
    - include_tasks: ./tasks/app_user.yml
    - include_tasks: ./tasks/s3cfg.yml
    - include_tasks: ./tasks/containerd.yml
    - include_tasks: ./tasks/keep_clean.yml
  roles:
    - geerlingguy.security
    - geerlingguy.kubernetes
  # tasks:
  #   - include_tasks: ./tasks/copy_kubeconfig.yml
