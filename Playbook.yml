---
- name: Base setup - User setup, fail2ban, security.
  hosts: all
  become: yes
  become_user: root
  become_method: sudo
  vars:
    fail2ban_services:
      - name: sshd
        port: 22
        bantime: 3600
    security_ssh_port: 22
    app_user: rihards #
    repo_path: /srv/repo
  roles:
    - common # User setup, set up auth stuff and clone repository
    - { role: angstwad.docker_ubuntu, when: ansible_architecture == 'x86_64' }
    - tersmitten.fail2ban
    - geerlingguy.security

- name: Bring up services
  hosts: production
  become: yes
  become_user: rihards
  tasks:
    # Docker compose service stuff
    - name: Docker compose up. Bring up the services
      docker_service: # https://docs.ansible.com/ansible/docker_service_module.html
        project_src: "/srv/repo/DockerGunicornARM/"
        state: present
        services: netdata,nginx,web,postgres

- name: Update documentation page
  hosts: production
  become: yes
  become_user: rihards
  vars:
    repo_path: /var/www/dok.rudenspavasaris.id.lv/
    app_user: rihards
  tasks:
    - name: Pip install mkdocs and cinder theme
      pip:
        name: mkdocs,mkdocs-cinder
        state: latest
        executable: pip3
      become: yes
      become_user: root # This pip install requires root

    - name: Clone/update the git repo
      git:
        repo: 'git@gitlab.com:RihardsT/cloud_project_documentation.git'
        dest: '{{ repo_path }}'
        depth: 1
        update: yes
        accept_hostkey: yes
        key_file: /home/{{ app_user }}/.ssh/for_clone
      register: git # For the when: git.changed below

    - name: Run mkdocs build
      command: mkdocs build
      args:
        chdir: '{{ repo_path }}'
      when: git.changed # do this when new changes have pulled from git

    - name: Restart Nginx service
      docker_service: # https://docs.ansible.com/ansible/docker_service_module.html
        project_src: "/srv/repo/DockerGunicornARM/"
        restarted: true
        state: present
        services: nginx
      when: git.changed # do this when new changes have pulled from git